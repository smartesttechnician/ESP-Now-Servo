#include <esp_now.h>
#include <WiFi.h>
#include <ESP32Servo.h>

Servo servoX;  // single servo

// Data structure to receive from sender
typedef struct struct_message {
    int joyX;
} struct_message;

struct_message incomingData;

// Callback function to receive data
void OnDataRecv(const esp_now_recv_info *info, const uint8_t *data, int len) {
    if (len == sizeof(incomingData)) {
        memcpy(&incomingData, data, sizeof(incomingData));

        // Map joystick value to servo angle
        int angleX = map(incomingData.joyX, 0, 4095, 0, 180);
        angleX = constrain(angleX, 0, 180);

        servoX.write(angleX);

        // Debugging
        Serial.print("Joystick: ");
        Serial.print(incomingData.joyX);
        Serial.print(" -> Servo Angle: ");
        Serial.println(angleX);
    } else {
        Serial.println("Data length mismatch.");
    }
}

void setup() {
    Serial.begin(115200);
    WiFi.mode(WIFI_STA);
    delay(100);

    // Initialize ESP-NOW
    if (esp_now_init() != ESP_OK) {
        Serial.println("Error initializing ESP-NOW");
        return;
    }

    // Register callback for receiving data
    esp_now_register_recv_cb(OnDataRecv);

    // Attach servo to GPIO 18
    servoX.attach(18);
    servoX.write(90); // start centered

    Serial.println("Receiver ready!");
}

void loop() {
    delay(20); // small delay for smooth updates
}
